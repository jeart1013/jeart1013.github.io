// =========================================
// è¨­å‚™åµæ¸¬èˆ‡åˆå§‹åŒ–
// =========================================

/**
 * åµæ¸¬æ˜¯å¦ç‚ºè¡Œå‹•è£ç½®
 * @returns {boolean} å¦‚æœæ˜¯æ‰‹æ©Ÿæˆ–å¹³æ¿è¿”å› true
 */
function isMobileDevice() {
    const userAgent = navigator.userAgent || navigator.vendor || window.opera;

    // æª¢æŸ¥å¸¸è¦‹çš„ç§»å‹•è¨­å‚™æ¨™è­˜
    const mobileRegex = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i;
    const isMobileUA = mobileRegex.test(userAgent);

    // æª¢æŸ¥è¢å¹•å¯¬åº¦ï¼ˆä½œç‚ºé¡å¤–é©—è­‰ï¼‰
    const isMobileScreen = window.innerWidth <= 768;

    // æª¢æŸ¥è§¸æ§æ”¯æ´
    const hasTouchScreen = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

    return isMobileUA || (isMobileScreen && hasTouchScreen);
}

/**
 * é¡¯ç¤ºå°æ‡‰å¹³å°çš„å…§å®¹
 */
function displayContent() {
    const pcContent = document.getElementById('pc-content');
    const mobileContent = document.getElementById('mobile-content');

    if (isMobileDevice()) {
        console.log('âœ… åµæ¸¬åˆ°è¡Œå‹•è£ç½® - è¼‰å…¥æ‰‹æ©Ÿç‰ˆå…§å®¹');
        mobileContent.classList.add('active');
        pcContent.classList.remove('active');
        initializeVideoPlayer('mobile');
    } else {
        console.log('âœ… åµæ¸¬åˆ°æ¡Œé¢è£ç½® - è¼‰å…¥ PC ç‰ˆå…§å®¹');
        pcContent.classList.add('active');
        mobileContent.classList.remove('active');
        initializeVideoPlayer('pc');
    }
}

// =========================================
// HLS å½±ç‰‡æ’­æ”¾å™¨è¨­å®šï¼ˆPC å’Œæ‰‹æ©Ÿç‰ˆï¼‰
// =========================================

let hls = null;
let totalDownloaded = 0;

/**
 * åˆå§‹åŒ– HLS å½±ç‰‡æ’­æ”¾å™¨
 * @param {string} platform - 'pc' æˆ– 'mobile'
 */
function initializeVideoPlayer(platform) {
    const videoPlayer = platform === 'pc'
        ? document.getElementById('pc-video-player')
        : document.getElementById('video-player');
    const videoStatus = platform === 'pc'
        ? document.getElementById('pc-video-status')
        : document.getElementById('video-status');

    // å–å¾—è³‡è¨Šé¡¯ç¤ºå…ƒç´ 
    const prefix = platform === 'pc' ? 'pc' : 'mobile';
    const infoElements = {
        resolution: document.getElementById(`${prefix}-resolution`),
        quality: document.getElementById(`${prefix}-quality`),
        bitrate: document.getElementById(`${prefix}-bitrate`),
        levels: document.getElementById(`${prefix}-levels`),
        downloaded: document.getElementById(`${prefix}-downloaded`)
    };

    if (!videoPlayer) {
        console.error('âŒ æ‰¾ä¸åˆ°å½±ç‰‡å…ƒç´ ');
        return;
    }

    // HLS ä¸²æµå½±ç‰‡ URL
    const videoUrl = 'video/master_all.m3u8'; // æœ¬åœ° HLS ä¸²æµ

    console.log(`ğŸ¬ æ­£åœ¨åˆå§‹åŒ– ${platform} ç‰ˆæœ¬å½±ç‰‡æ’­æ”¾å™¨...`);

    if (!Hls.isSupported()) {
        console.warn('âš ï¸ HLS.js ä¸æ”¯æ´æ­¤ç€è¦½å™¨');

        // å¦‚æœåŸç”Ÿæ”¯æ´ HLSï¼ˆå¦‚ Safariï¼‰
        if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
            console.log('âœ… ä½¿ç”¨åŸç”Ÿ HLS æ’­æ”¾');
            videoPlayer.src = videoUrl;
            videoPlayer.muted = true;
            videoPlayer.play().catch(err => {
                console.error('è‡ªå‹•æ’­æ”¾å¤±æ•—:', err);
                updateStatus('è«‹é»æ“Šé é¢å•Ÿå‹•', videoStatus, true);
            });
            updateStatus('èƒŒæ™¯æ’­æ”¾ä¸­', videoStatus);

            // æ›´æ–°åŸºæœ¬è³‡è¨Šï¼ˆåŸç”Ÿæ’­æ”¾ï¼‰
            videoPlayer.addEventListener('loadedmetadata', () => {
                updateVideoInfo(infoElements, {
                    resolution: `${videoPlayer.videoWidth}Ã—${videoPlayer.videoHeight}`,
                    quality: 'è‡ªå‹•',
                    bitrate: '-',
                    levels: 'åŸç”Ÿæ’­æ”¾',
                    downloaded: '-'
                });
            });
        } else {
            updateStatus('ä¸æ”¯æ´ HLS æ’­æ”¾', videoStatus, true);
        }
        return;
    }

    // åˆå§‹åŒ– HLS.js
    hls = new Hls({
        enableWorker: true,
        lowLatencyMode: true,
        backBufferLength: 90,
        startLevel: 4,  // å¾æœ€ä½ç•«è³ªé–‹å§‹ï¼ˆ480pï¼‰
        maxAutoLevel: 3,  // æœ€é«˜åªè‡ªå‹•å‡ç´šåˆ° 720pï¼Œä¸æœƒè·³åˆ° 1080p/2K/4K
        maxBufferLength: 30,
        maxMaxBufferLength: 60
    });

    // ç¢ºä¿å½±ç‰‡éœéŸ³
    videoPlayer.muted = true;
    totalDownloaded = 0;
    document.removeEventListener('click', playOnClick);
}, { once: true });
        });
    });

// ç•«è³ªç­‰ç´šåˆ‡æ›
hls.on(Hls.Events.LEVEL_SWITCHED, function (event, data) {
    const level = hls.levels[data.level];
    const resolution = `${level.width}Ã—${level.height}`;
    const bitrate = (level.bitrate / 1000000).toFixed(2) + ' Mbps';

    updateVideoInfo(infoElements, {
        resolution: resolution,
        quality: `${level.height}p`,
        bitrate: bitrate
    });

    console.log(`ğŸ¬ ç•«è³ªåˆ‡æ›è‡³: ${level.height}p (${resolution})`);
});

// ç‰‡æ®µè¼‰å…¥å®Œæˆ
hls.on(Hls.Events.FRAG_LOADED, function (event, data) {
    const fragSize = data.frag.stats.total / 1024 / 1024; // MB
    totalDownloaded += fragSize;

    updateVideoInfo(infoElements, {
        downloaded: totalDownloaded.toFixed(2) + ' MB'
    });
});

// éŒ¯èª¤è™•ç†
hls.on(Hls.Events.ERROR, function (event, data) {
    console.error('âŒ HLS éŒ¯èª¤:', data);

    if (data.fatal) {
        switch (data.type) {
            case Hls.ErrorTypes.NETWORK_ERROR:
                console.error('ç¶²è·¯éŒ¯èª¤ï¼Œå˜—è©¦æ¢å¾©...');
                updateStatus('ç¶²è·¯éŒ¯èª¤ï¼Œé‡é€£ä¸­...', videoStatus, true);
                hls.startLoad();
                break;
            case Hls.ErrorTypes.MEDIA_ERROR:
                console.error('åª’é«”éŒ¯èª¤ï¼Œå˜—è©¦æ¢å¾©...');
                updateStatus('åª’é«”éŒ¯èª¤ï¼Œä¿®å¾©ä¸­...', videoStatus, true);
                hls.recoverMediaError();
                break;
            default:
                console.error('ç„¡æ³•æ¢å¾©çš„éŒ¯èª¤');
                updateStatus('æ’­æ”¾å¤±æ•—', videoStatus, true);
                hls.destroy();
                break;
        }
    }
});

// ===== å½±ç‰‡å…ƒç´ äº‹ä»¶ç›£è½ =====

videoPlayer.addEventListener('loadedmetadata', function () {
    const resolution = `${videoPlayer.videoWidth}Ã—${videoPlayer.videoHeight}`;
    updateVideoInfo(infoElements, {
        resolution: resolution
    });
});

videoPlayer.addEventListener('play', function () {
    updateStatus('èƒŒæ™¯æ’­æ”¾ä¸­', videoStatus);
});

videoPlayer.addEventListener('pause', function () {
    updateStatus('å·²æš«åœ', videoStatus);
});

videoPlayer.addEventListener('waiting', function () {
    updateStatus('ç·©è¡ä¸­...', videoStatus);
});

videoPlayer.addEventListener('canplay', function () {
    updateStatus('èƒŒæ™¯æ’­æ”¾ä¸­', videoStatus);
});

videoPlayer.addEventListener('playing', function () {
    updateStatus('èƒŒæ™¯æ’­æ”¾ä¸­', videoStatus);
    console.log('âœ… å½±ç‰‡æ­£åœ¨æ’­æ”¾');
});

videoPlayer.addEventListener('error', function (e) {
    console.error('âŒ å½±ç‰‡å…ƒç´ éŒ¯èª¤:', e);
    updateStatus('å½±ç‰‡è¼‰å…¥å¤±æ•—', videoStatus, true);
});
}

/**
 * æ›´æ–°å½±ç‰‡è³‡è¨Šé¡¯ç¤º
 * @param {Object} elements - è³‡è¨Šå…ƒç´ ç‰©ä»¶
 * @param {Object} data - è¦æ›´æ–°çš„è³‡æ–™
 */
function updateVideoInfo(elements, data) {
    if (data.resolution && elements.resolution) {
        elements.resolution.textContent = data.resolution;
        elements.resolution.classList.add('highlight');
    }
    if (data.quality && elements.quality) {
        elements.quality.textContent = data.quality;
        elements.quality.classList.add('highlight');
    }
    if (data.bitrate && elements.bitrate) {
        elements.bitrate.textContent = data.bitrate;
    }
    if (data.levels && elements.levels) {
        elements.levels.textContent = data.levels;
    }
    if (data.downloaded && elements.downloaded) {
        elements.downloaded.textContent = data.downloaded;
    }
}

/**
 * æ›´æ–°ç‹€æ…‹é¡¯ç¤º
 * @param {string} message - ç‹€æ…‹è¨Šæ¯
 * @param {HTMLElement} statusElement - ç‹€æ…‹å…ƒç´ 
 * @param {boolean} isError - æ˜¯å¦ç‚ºéŒ¯èª¤è¨Šæ¯
 */
function updateStatus(message, statusElement, isError = false) {
    if (statusElement) {
        statusElement.textContent = message;
        statusElement.style.color = isError ? '#ff4757' : '#00d4ff';

        if (isError) {
            statusElement.classList.remove('highlight');
        } else {
            statusElement.classList.add('highlight');
        }
    }
}

// =========================================
// é é¢è¼‰å…¥èˆ‡æ¸…ç†
// =========================================

/**
 * é é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
 */
document.addEventListener('DOMContentLoaded', function () {
    console.log('ğŸš€ é é¢åˆå§‹åŒ–');
    displayContent();
});

/**
 * è¦–çª—å¤§å°æ”¹è®Šæ™‚é‡æ–°åµæ¸¬ï¼ˆé˜²æ­¢æ—‹è½‰è¨­å‚™ï¼‰
 */
let resizeTimer;
window.addEventListener('resize', function () {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(function () {
        console.log('ğŸ”„ è¢å¹•å¤§å°æ”¹è®Šï¼Œé‡æ–°åµæ¸¬è£ç½®');

        // æ¸…ç†èˆŠçš„ HLS å¯¦ä¾‹
        if (hls) {
            hls.destroy();
            hls = null;
        }

        totalDownloaded = 0;
        displayContent();
    }, 500);
});

/**
 * é é¢å¸è¼‰æ™‚æ¸…ç†è³‡æº
 */
window.addEventListener('beforeunload', function () {
    if (hls) {
        hls.destroy();
        console.log('ğŸ§¹ HLS æ’­æ”¾å™¨å·²æ¸…ç†');
    }
});

// =========================================
// é™¤éŒ¯å·¥å…·ï¼ˆé–‹ç™¼ç”¨ï¼‰
// =========================================

// åœ¨æ§åˆ¶å°é¡¯ç¤ºè¨­å‚™è³‡è¨Š
console.log('ğŸ“± è¨­å‚™è³‡è¨Š:', {
    userAgent: navigator.userAgent,
    è¢å¹•å¯¬åº¦: window.innerWidth,
    è¢å¹•é«˜åº¦: window.innerHeight,
    è§¸æ§æ”¯æ´: 'ontouchstart' in window,
    å¹³å°: navigator.platform,
    æ˜¯å¦ç‚ºè¡Œå‹•è£ç½®: isMobileDevice()
});
